#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
프롬프트 템플릿 모듈
다양한 상황에 맞는 프롬프트 템플릿 정의
"""

import os
import sys
import random
from typing import List, Dict, Any

# 상위 디렉토리 import를 위한 경로 추가
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
import config

# 썰 주제 카테고리
STORY_CATEGORIES = {
    "가족": ["상속", "갈등", "배신", "며느리", "시댁", "결혼", "이혼", "재혼", "불화", "폭로"],
    "이웃": ["아파트", "주차", "소음", "층간소음", "분쟁", "민원", "싸움", "갈등", "폭로"],
    "직장": ["상사", "부하", "퇴직", "해고", "승진", "갑질", "배신", "꼰대", "연봉", "계약"],
    "금전": ["사기", "빚", "투자", "부동산", "사채", "상속세", "빚보증", "파산"],
    "건강": ["수술", "병원", "의사", "진단", "오진", "치료", "약물", "응급실"],
    "관계": ["불륜", "친구", "배신", "연애", "이별", "결혼", "바람", "파경"]
}

# 썰 스타일 변형
STORY_STYLES = [
    "자극적이고 충격적인",
    "공감가는 현실적인",
    "반전이 있는",
    "생생한 디테일이 살아있는",
    "감정을 자극하는",
    "긴장감 넘치는",
    "기막힌 우연이 있는",
    "교훈이 담긴"
]

# 도입부 템플릿 (반말 버전)
INTRO_TEMPLATES = [
    "야, 그날이 바로 {요일}이었거든? 근데 갑자기...",
    "{장소}에서 있었던 일인데, 아직도 생각하면 소름 돋아.",
    "평생 못 잊을 {경험}을 들려줄게. 진짜 실화임.",
    "{시간}에 걸려온 전화 한 통이 내 인생을 완전히 뒤집어놨어.",
    "{개월} 전, {장소}에서 있었던 일인데 지금 생각해도 화가 나.",
    "우리 {관계}이 겪은 일인데, 진짜 믿기 힘든 이야기야.",
    "{나이}의 내가 겪은 황당한 경험 들어볼래?",
    "오늘 내가 말하는 이야기는 절대 남한테 말하지 마."
]

# 중간부 전환 템플릿 (반말 버전)
TRANSITION_TEMPLATES = [
    "근데 가만 보니까 이상한 점을 발견했어.",
    "그런데 그게 전부가 아니었어.",
    "상황은 점점 더 이상하게 흘러갔어.",
    "그때 진짜 예상치 못한 일이 벌어졌다고.",
    "그러다 우연히 알게 된 사실인데 말이야.",
    "참다 참다 더는 못 참겠어서...",
    "그리고 결정적인 증거를 발견했어.",
    "그 순간 모든 게 명확해졌지."
]

# 결말 템플릿 (반말 버전)
ENDING_TEMPLATES = [
    "결국 나는 {행동}하기로 결심했어. 너라면 어떻게 했을 것 같아? 댓글로 알려줘.",
    "그 일이 있고 나서 {결과}가 됐어. 진짜 인생 알 수 없더라.",
    "지금까지도 그 {대상}과는 연락 끊었어. 가끔 생각나면 아직도 화가 나.",
    "그 후로 {기간}이 지났는데, 아직도 그날 생각하면 가슴이 쿵쾅거려.",
    "너도 이런 경험 있어? 댓글로 공유해줘.",
    "이런 일을 겪고 나서 내 가치관이 완전히 바뀌었어.",
    "결국 CCTV를 확인해봤는데 충격적인 진실이 드러났어.",
    "그 사건 이후 {대상}은 다시는 그런 짓을 못하게 됐지."
]

def get_story_prompt(keyword: str) -> str:
    """
    키워드를 기반으로 스토리 생성 프롬프트 작성
    
    Args:
        keyword: 스토리 생성에 사용할 키워드
        
    Returns:
        완성된 프롬프트 문자열
    """
    # 키워드로 카테고리 추측
    category = _guess_category(keyword)
    
    # 랜덤 스타일 선택
    style = random.choice(STORY_STYLES)
    
    # 프롬프트 구성
    prompt = f"""
[키워드]: {keyword}
[요청]: {keyword} 키워드에 맞는 30초~1분 내외의 자극적인 썰을 만들어주세요. 중장년층(45-60대)이 공감할 수 있는 상황을 설정해서 현실적이고 {style} 톤으로 작성해주세요.

[스타일]: 
- 말투: 친구에게 이야기하듯 반말로 작성 (예: '했습니다' → '했어', '있었습니다' → '있었어')
- 톤: 친근하고 구어체로, 감정이 생생하게 드러나게
- 디테일: 실제 겪은 듯한 구체적인 세부 사항 포함
- 개연성: 현실적이고 말이 되는 상황 설정
- 구성: 명확한 시작, 전개, 반전이 있는 결말

[형식]:
1. 도입부: 호기심을 유발하는 강렬한 시작
2. 중간: 상황 설명과 갈등 구체화 (논리적 흐름 필요)
3. 마무리: 충격적이거나 의외의 반전이 있는 결말

[주의사항]:
- 250단어 이내로 작성해주세요.
- {category} 관련 이야기가 적합합니다.
- 반드시 개연성 있는 흐름으로 진행되어야 합니다.
- 중장년층이 공감할 수 있는 현실적인 상황이어야 합니다.
- 너무 폭력적이거나 선정적인 내용은 지양해주세요.
- 친구에게 말하듯 1인칭 반말 시점으로 작성해주세요.
- 이야기의 앞뒤가 맞아야 하고 납득 가능해야 합니다.
- 댓글 유도 문구를 자연스럽게 포함시켜주세요.

[예시 도입부]:
{random.choice(INTRO_TEMPLATES).format(요일=random.choice(['월요일', '화요일', '수요일', '목요일', '금요일', '주말']), 
                                    장소=random.choice(['아파트', '시장', '병원', '직장', '동창회', '시댁']),
                                    경험=random.choice(['경험', '사건', '이야기', '일화']),
                                    시간=random.choice(['새벽', '아침', '오후', '저녁', '밤늦게']),
                                    개월=random.choice(['3', '6', '1', '2']),
                                    관계=random.choice(['친정어머니', '시어머니', '형', '동생', '친구', '이웃']),
                                    나이=random.choice(['50대', '40대', '60대']))}
    """
    
    return prompt

def get_story_prompt_multi_keywords(keywords: List[str]) -> str:
    """
    여러 키워드를 기반으로 스토리 생성 프롬프트 작성
    
    Args:
        keywords: 스토리 생성에 사용할 키워드 목록
        
    Returns:
        완성된 프롬프트 문자열
    """
    # 모든 키워드 결합
    combined_keyword = ", ".join(keywords)
    
    # 랜덤 스타일 선택
    style = random.choice(STORY_STYLES)
    
    # 반전 유형 목록
    twist_types = [
        "신분/정체 반전 (누군가의 비밀 정체가 드러나는)",
        "배신/변절 반전 (믿었던 사람의 배신)",
        "반대 상황 반전 (상황이 완전히 반대로 뒤집히는)",
        "진실 폭로 반전 (숨겨진 진실이 드러나는)",
        "의도적 속임수 반전 (계획된 속임수)",
        "착각/오해 반전 (처음부터 상황을 오해했던)",
        "도덕적 딜레마 반전 (옳고 그름이 뒤바뀌는)",
        "예상 빗나감 반전 (예상과 완전히 다른 결과)",
        "시간/공간 반전 (생각했던 시간이나 장소가 아니었던)",
        "복수/설계 반전 (계획된 복수가 밝혀지는)"
    ]
    
    # 랜덤 반전 유형 선택
    selected_twist = random.choice(twist_types)
    
    # 프롬프트 구성
    prompt = f"""
[키워드]: {combined_keyword}
[요청]: 다음 키워드들을 모두 포함하는 30초~1분 내외의 자극적인 썰을 만들어주세요: {combined_keyword}. 중장년층(45-60대)이 공감할 수 있는 상황을 설정해서 현실적이고 {style} 톤으로 작성해주세요.

[스타일]: 
- 말투: 친구에게 이야기하듯 반말로 작성 (예: '했습니다' → '했어', '있었습니다' → '있었어')
- 톤: 친근하고 구어체로, 감정이 생생하게 드러나게
- 디테일: 실제 겪은 듯한 구체적인 세부 사항 포함
- 개연성: 현실적이고 말이 되는 상황 설정 (억지스럽지 않게)
- 구성: 명확한 시작, 전개, 강력한 반전이 있는 결말

[반전 유형]: {selected_twist}
- 이야기 초반에는 반전을 눈치채지 못하게 자연스럽게 포석을 깔아두세요
- 이야기 후반부에 독자가 "헉!" 하고 놀랄만한 강력한 반전을 넣으세요
- 반전은 이전 이야기와 논리적으로 연결되어야 하며, 개연성이 있어야 합니다
- 반전 후에는 초반의 상황이 새로운 관점에서 이해되도록 만드세요

[형식]:
1. 도입부: 호기심을 유발하는 강렬한 시작 (반전을 위한 복선 포함)
2. 중간: 상황 설명과 갈등 구체화 (논리적이고 개연성 있게)
3. 마무리: 강력한 반전과 충격적인 결말 (초반 복선이 회수되는 방식)

[주의사항]:
- 250단어 이내로 작성해주세요.
- 모든 키워드({combined_keyword})를 자연스럽게 이야기에 통합해주세요.
- 반드시 개연성 있는 흐름과 논리적 전개가 필요합니다.
- 이야기의 앞뒤가 맞아야 하고 납득 가능해야 합니다.
- 반전이 반드시 포함되어야 하며, 독자가 "헉!" 하고 놀랄 정도로 충격적이어야 합니다.
- 중장년층이 공감할 수 있는 현실적인 상황이어야 합니다.
- 너무 폭력적이거나 선정적인 내용은 지양해주세요.
- 친구에게 말하듯 1인칭 반말 시점으로 작성해주세요.
- 댓글 유도 문구를 자연스럽게 포함시켜주세요.

[예시 도입부]:
{random.choice(INTRO_TEMPLATES).format(요일=random.choice(['월요일', '화요일', '수요일', '목요일', '금요일', '주말']), 
                                    장소=random.choice(['아파트', '시장', '병원', '직장', '동창회', '시댁']),
                                    경험=random.choice(['경험', '사건', '이야기', '일화']),
                                    시간=random.choice(['새벽', '아침', '오후', '저녁', '밤늦게']),
                                    개월=random.choice(['3', '6', '1', '2']),
                                    관계=random.choice(['친정어머니', '시어머니', '형', '동생', '친구', '이웃']),
                                    나이=random.choice(['50대', '40대', '60대']))}
    """
    
    return prompt

def get_title_prompt(story: str, keyword: str) -> str:
    """
    스토리를 기반으로 제목 생성 프롬프트 작성
    
    Args:
        story: 생성된 스토리 내용
        keyword: 원본 키워드
        
    Returns:
        제목 생성 프롬프트
    """
    # 중괄호를 이스케이프 처리하기 위해 {{ }}로 변경
    prompt = f"""
다음 스토리에 대한 유튜브 쇼츠용 제목을 만들어주세요:

[스토리]
{story}

[키워드]
{keyword}

[요청]
위 스토리의 내용을 바탕으로 클릭을 유도하는 자극적이고 호기심을 자극하는 유튜브 쇼츠 제목을 만들어주세요.

[제목 형식]
- 짧고 임팩트 있게 (12-15자 사이)
- 핵심 키워드나 반전 요소 포함
- '썰', 'ㄷㄷ' 같은 표현 사용 가능
- 궁금증을 유발하는 미완성 문장 또는 질문형으로 끝내도 좋음

[제목 예시 형식]
"{{주제}} 때문에 {{결과}} 된 썰"
"{{장소}}에서 {{사건}} 겪은 썰 ㄷㄷ"
"{{대상}}이 {{행동}}했더니 충격적인 결말.."
"{{상황}} 때문에 {{감정}} 썰.."

한 줄로 제목만 작성해주세요.
    """
    
    return prompt

def get_hashtags_prompt(story: str, title: str, keyword: str) -> str:
    """
    스토리와 제목을 기반으로 해시태그 생성 프롬프트 작성
    
    Args:
        story: 생성된 스토리 내용
        title: 생성된 제목
        keyword: 원본 키워드
        
    Returns:
        해시태그 생성 프롬프트
    """
    prompt = f"""
다음 스토리와 제목에 적합한 유튜브 쇼츠용 해시태그를 만들어주세요:

[스토리]
{story}

[제목]
{title}

[키워드]
{keyword}

[요청]
위 스토리와 제목을 바탕으로 유튜브 검색과 노출에 효과적인 해시태그 10개를 만들어주세요.

[해시태그 형식]
- 각 해시태그는 '#'으로 시작
- 인기 있는 일반 해시태그 포함 (#레전드썰, #실화썰 등)
- 스토리 내용과 관련된 구체적인 해시태그 포함
- 중장년층이 검색할 만한 키워드 포함
- 짧고 간결하게 작성

해시태그 10개만 한 줄로 나열해서 제시해주세요. (예: #레전드썰 #실화썰 #아파트썰 ...)
    """
    
    return prompt

def _guess_category(keyword: str) -> str:
    """
    키워드를 분석하여 가장 적합한 카테고리 추측
    
    Args:
        keyword: 입력 키워드
        
    Returns:
        추측된 카테고리명
    """
    # 각 카테고리별 키워드 매칭 점수 계산
    category_scores = {}
    
    for category, keywords in STORY_CATEGORIES.items():
        score = 0
        for k in keywords:
            if k in keyword:
                score += 3  # 직접 포함된 경우 가중치 부여
            elif any(k in w for w in keyword.split()):
                score += 1  # 단어의 일부로 포함된 경우
        
        category_scores[category] = score
    
    # 최고 점수 카테고리 반환 (동점인 경우 랜덤 선택)
    max_score = max(category_scores.values())
    if max_score > 0:
        top_categories = [cat for cat, score in category_scores.items() if score == max_score]
        return random.choice(top_categories)
    
    # 매칭되는 것이 없으면 랜덤 카테고리 반환
    return random.choice(list(STORY_CATEGORIES.keys()))